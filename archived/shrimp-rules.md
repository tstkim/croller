# 범용 쇼핑몰 크롤러 AI Agent 개발 가이드라인

## 프로젝트 핵심 원칙 (CRITICAL PRIORITIES)

### AI 의사결정 우선순위
- **범용성** > 특정 사이트 최적화
- **자동 탐지** > 수동 선택자 설정  
- **기존 구조 보존** > 새로운 기능 추가
- **안정성** > 성능 최적화

### 절대 금지 사항 (STRICTLY PROHIBITED)
- 특정 사이트 하드코딩 (`if "특정쇼핑몰" in page.url:` 형태 코드 작성 금지)
- 결과물 형식 임의 변경 (엑셀 헤더 순서, 이미지 경로/이름/크기 규격 변경 금지)
- `perfect_result_*.json`의 필수 키 이름 변경 또는 삭제 금지
- **`config.py` 파일 수정 금지: 사용자 전용 설정 파일이므로 AI는 절대 수정 불가.**
- 디버깅 로그 포함 커밋 (`print()`, `console.log()` 등 최종 코드에 포함 금지)
- 이모지 사용 절대 금지 (인코딩 오류 방지)

## 프로젝트 아키텍처 (MANDATORY WORKFLOW)

### 데이터 흐름 (순서 준수 필수)
```
config.py → final_analyzer_universal.py → perfect_result_*.json → main.py → 최종 결과물
```

### 개발 및 테스트 워크플로우 (엄격한 순서)
1. **[설정]** `config.py` 수정 - PRODUCT_LINK_PATTERN, URL, 로그인 정보 등
2. **[탐지]** `python final_analyzer_universal.py` 실행
3. **[검증]** `perfect_result_*.json` 파일 유효성 확인 (필수 키 포함 여부)
4. **[실행]** `python main.py` 실행으로 실제 크롤링 수행
5. **[최종검증]** 결과물 품질 기준 충족 확인

## 파일별 수정 규칙 (FILE-SPECIFIC RULES)

### config.py
- **⚠️ AI 에이전트 수정 절대 금지**: 이 파일은 사용자가 직접 사이트별 설정을 관리하는 파일입니다. AI 에이전트는 이 파일을 절대 읽거나 수정해서는 안 됩니다.
- **허용 (사용자만)**: PRODUCT_LINK_PATTERN, 브랜드명, URL, 로그인 정보, 페이지 범위 등 **값(Value)** 변경
- **금지**: 새로운 사이트별 하드코딩 변수 추가, 기존 변수명 변경 및 구조 수정
- **필수 후속 조치**: PRODUCT_LINK_PATTERN 변경 시 `final_analyzer_universal.py` 관련 로직 동기화 확인

### final_analyzer_universal.py & smart_detector_final.py  
- **허용**: 범용성을 높이는 탐지 로직 개선, 새로운 범용 선택자 패턴 추가
- **금지**: 특정 사이트에만 적용되는 선택자 또는 로직 추가
- **절대 금지**: `perfect_result_*.json`의 키(key) 이름 변경
- **필수 후속 조치**: 로직 변경 후 전체 테스트 워크플로우 수행

### main.py
- **허용**: 로그 메시지 개선, 오류 처리 강화, 성능 최적화(안정성 저해 금지)
- **금지**: 
  - 엑셀 헤더 순서 또는 `sheet.append([...])` 인덱스 변경
  - 썸네일, 상세 이미지의 저장 경로 및 파일명 규칙 변경
  - 이미지 크기 및 캔버스 규격 변경

## 코딩 표준 (CODING STANDARDS)

### 선택자 추출 위치 원칙

- **모든 상품 정보(상품명, 가격, 옵션, 이미지 등)는 반드시 개별 상품 상세페이지에서 추출해야 한다.**
- 갤러리(목록/카테고리/검색 결과 등) 페이지에서 직접 정보 추출하는 것은 금지한다.
- 단, 상품 상세페이지 진입이 불가능한 구조(예: 비로그인, 품절, 삭제 등)인 경우에만 예외적으로 `[SKIP]` 로그와 함께 해당 상품을 건너뛴다.
- 이 원칙은 모든 크롤링/탐지/분석 로직에 우선 적용된다.

### Python 코드 규칙
- **명명 규칙**: 기존 변수명 규칙 일관되게 따름 (`product_name`, `adjusted_price` 등)
- **예외 처리**: 모든 네트워크 요청, 파일 I/O 등 외부 자원 접근 시 `try...except` 필수
- **이모지 금지**: 코드, 주석, 로그 등 모든 영역에서 이모지 사용 절대 금지

### JSON 데이터 규칙 (perfect_result_*.json)
- **키(Key) 불변**: `'상품리스트', '상품명', '가격', '선택옵션', '썸네일', '상세페이지'` 키 절대 변경/삭제 금지
- **키 추가**: 새로운 키 추가는 허용하지만 기존 키와 로직에 영향 주지 않아야 함

### 로그 전략  
- **접두사 사용**: `[INFO]`, `[DEBUG]`, `[ERROR]`, `[WARNING]`, `[FALLBACK]`, `[SKIP]` 등 명확한 접두사 사용
- **상세한 실패 기록**: 실패 로그에는 **원인, 위치, 후속 조치** 명확히 포함
- **Fallback 명시**: Fallback 로직 동작 시 `[FALLBACK]` 로그로 명시적 알림

## 결과물 품질 기준 (DELIVERABLES QUALITY)

### 필수 결과물 경로 및 형식
- **엑셀 파일**: `C:/Users/ME/Pictures/{tdate}{code}.xlsx`
- **썸네일**: `{base_path}/cr/{image_counter}_cr.jpg`
- **상세 이미지**: `{base_path}/output/{image_counter:03}_{1-10:03}.jpg`

### 품질 기준
- **썸네일**: 650x650px 흰색(#FFFFFF) 캔버스 중앙에 원본 비율 유지한 최대 600x600px 상품 이미지, 우측 상단 S2B 배지
- **상세 이미지**: 가로 해상도 660px 이상 이미지만 대상으로 10개 조각으로 균등 분할
- **엑셀**: 기존 정의된 헤더 순서 및 데이터 형식 완벽 준수

## 예외 처리 및 Fallback 전략

### 부분 성공 처리
- 상품명, 가격 등 필수 정보 일부 누락 시 `[SKIP]` 또는 `[PARTIAL SUCCESS]` 로그 후 다음 상품으로 진행
- 전체 프로세스 중단 금지

### 무의미한 이미지 필터링
- 워터마크, 안내용 이미지 등 불필요한 이미지는 파일 크기, 해상도(가로 660px 미만), 정규식, 의미 필터 등 다중 조건으로 필터링

### 사이트별 예외 처리
- 특정 사이트의 고유한 구조는 범용 로직 수정 대신 `config.py` 설정 추가 또는 별도 조건문으로 분기 처리
- 범용 코드 오염 최소화

### 데이터 유효성 검증
- **상품명 중복 오류**: 여러 상품에서 동일한 상품명이 추출되는 것은 카테고리명이 잘못 수집된 오류로 간주합니다. 중복 상품명 감지 시, 해당 데이터는 즉시 건너뛰고 `[SKIP]` 로그를 기록해야 합니다.
- **가격 필터링 오류**: `config.py`에 설정된 기준 금액보다 낮은 가격의 상품이 추출되어서는 안 됩니다. `main.py`는 반드시 이 가격 필터링 로직을 수행하여 기준 미달 상품을 걸러내야 합니다.
- **선택 옵션 가격 검증**: 선택 옵션이 있는 상품의 경우, 옵션에 따라 가격이 변동되어 잘못 추출될 가능성이 높습니다. 최종 추출된 가격이 옵션을 포함한 실제 판매 가격을 정확하게 반영하는지 반드시 검증해야 합니다. 복잡한 옵션 구조로 인해 가격 검증이 어려운 경우, `[PRICE_OPTION_ERROR]` 로그를 남기고 해당 상품을 건너뛰어야 합니다.

## 특수 요구사항 처리 (SPECIAL REQUIREMENTS)

### 상세설명 텍스트 추출 (키드짐 등)
- `final_analyzer_universal.py`에서 상세설명 텍스트 선택자 탐지 로직 추가
- `perfect_result_*.json`에 새로운 키 추가 시 기존 키에 영향 주지 않도록 주의
- `config.py`에 사이트별 특수 설정 추가 가능하지만 범용 로직 오염 금지

### 다중 파일 동시 수정 요구사항
- `config.py` 수정 시 `final_analyzer_universal.py`의 관련 로직 동기화 확인 필수
- `perfect_result_*.json` 구조 변경 시 `main.py`의 해당 처리 로직 동시 수정 필수

## AI Agent 행동 지침

### 작업 시작 전 확인사항
1. 현재 프로젝트 구조 및 기존 파일 상태 확인
2. 변경 사항이 범용성 원칙에 부합하는지 검토
3. 기존 구조에 미칠 영향 평가

### 충돌 상황 해결 기준
1. 범용성과 특정 사이트 최적화 충돌 시 → 범용성 선택
2. 자동 탐지와 수동 설정 충돌 시 → 자동 탐지 선택
3. 기존 구조 보존과 새 기능 추가 충돌 시 → 기존 구조 보존 선택
4. 안정성과 성능 최적화 충돌 시 → 안정성 선택

### 검증 절차
- 모든 변경 사항은 개발 및 테스트 워크플로우 5단계 완전 수행
- 각 단계별 성공 확인 후 다음 단계 진행
- 실패 시 원인 분석 및 로그 기록 후 수정

**경고**: 이 가이드라인 위반 시 프로젝트의 안정성과 범용성이 심각하게 훼손될 수 있습니다.
